// MTG Import App - Standalone Prisma Schema
// Shares the same physical database as inventory-ops.
// Only defines models this app owns + AppInstallation for FK relationships.
// AppInstallation DDL is owned by inventory-ops — mtg-import never migrates it.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

// Multi-tenant root — shared table, DDL owned by inventory-ops
model AppInstallation {
  id           String   @id @default(uuid())
  saleorApiUrl String
  appId        String
  installedAt  DateTime @default(now())

  importJobs     ImportJob[]
  setAudits      SetAudit[]
  importSettings ImportSettings?

  @@unique([saleorApiUrl, appId])
  @@index([saleorApiUrl])
}

// ============================================
// MTG Import Models (owned by this app)
// ============================================

enum ImportJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ImportJobType {
  SET        // Import a specific set by code
  BULK       // Full bulk data import
  BACKFILL   // Re-import missing/updated cards
}

// Import job tracking
model ImportJob {
  id             String          @id @default(uuid())
  installationId String
  installation   AppInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  type     ImportJobType
  status   ImportJobStatus @default(PENDING)
  priority Int             @default(2) // 0=prerelease, 1=reprint, 2=backfill

  // Set filter (null = all sets)
  setCode String?

  // Progress tracking
  cardsProcessed  Int @default(0)
  cardsTotal      Int @default(0)
  variantsCreated Int @default(0)
  errors          Int @default(0)
  skipped         Int @default(0)

  // Resume support: last processed card ID for checkpoint
  lastCheckpoint String?

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Error details
  errorMessage String?
  errorLog     String? // JSON array of individual card errors

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  importedProducts ImportedProduct[]

  @@index([installationId])
  @@index([status])
  @@index([priority, status])
}

// Track which Scryfall cards have been imported to Saleor
model ImportedProduct {
  id          String    @id @default(uuid())
  importJobId String
  importJob   ImportJob @relation(fields: [importJobId], references: [id], onDelete: Cascade)

  // Scryfall identifiers
  scryfallId  String  // Scryfall oracle_id or id
  scryfallUri String? // Scryfall card URI for reference

  // Card metadata (denormalized for quick lookups)
  cardName        String
  setCode         String
  collectorNumber String
  rarity          String // common, uncommon, rare, mythic

  // Saleor mapping
  saleorProductId String // Saleor product ID after creation
  variantCount    Int    @default(15) // Number of variants created (5 conditions x 3 finishes)

  // Status
  success       Boolean @default(true)
  errorMessage  String?
  mediaAttached Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([scryfallId, setCode])
  @@index([importJobId])
  @@index([setCode])
  @@index([saleorProductId])
}

// Track set-level import audits
model SetAudit {
  id             String          @id @default(uuid())
  installationId String
  installation   AppInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  setCode    String
  setName    String
  totalCards Int
  importedCards  Int
  lastImportedAt DateTime

  // Scryfall metadata
  releasedAt DateTime?
  setType    String? // core, expansion, masters, etc.
  iconSvgUri String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([installationId, setCode])
  @@index([installationId])
}

// Per-installation import configuration
model ImportSettings {
  id             String          @id @default(uuid())
  installationId String          @unique
  installation   AppInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)

  // Saleor targets (channels + warehouses are multi-select)
  channelSlugs    String[] @default(["webstore", "singles-builder"])
  productTypeSlug String   @default("mtg-card")
  categorySlug    String   @default("mtg-singles")
  warehouseSlugs  String[] @default([])

  // Pricing — condition multipliers (NM = base, others discounted)
  conditionNm    Float @default(1.0)
  conditionLp    Float @default(0.9)
  conditionMp    Float @default(0.75)
  conditionHp    Float @default(0.5)
  conditionDmg   Float @default(0.25)
  defaultPrice   Float @default(0.25)
  costPriceRatio Float @default(0.5)

  // Product defaults
  isPublished            Boolean @default(true)
  visibleInListings      Boolean @default(true)
  isAvailableForPurchase Boolean @default(true)
  trackInventory         Boolean @default(false)

  // Import behavior
  importableSetTypes String[] @default(["core", "expansion", "masters", "draft_innovation", "commander", "starter", "funny"])
  physicalOnly       Boolean  @default(true)

  updatedAt DateTime @updatedAt
}
